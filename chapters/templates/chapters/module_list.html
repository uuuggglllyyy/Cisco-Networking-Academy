{% extends 'chapters/base.html' %}

{% block title %}–ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–∞ - Cisco Networking Academy{% endblock %}

{% block content %}
<div class="main-container">
    <div class="content-wrapper">
        <h2>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∫—É—Ä—Å–∞</h2>
        <div class="module-list">
            {% for module in modules %}
            <a href="{% url 'module_detail' module.id %}" class="module-card">
                <h3>–ú–æ–¥—É–ª—å {{ module.number }}. {{ module.title }}</h3>
                {% if module.description %}
                <p>{{ module.description }}</p>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å AI-–ø–æ–º–æ—â–Ω–∏–∫–æ–º -->
    <div class="chat-sidebar">
        <div class="chat-container">
            <div class="chat-header">
                <h3>ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫ Cisco</h3>
                <button class="chat-toggle" onclick="toggleChat()">‚àí</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-content">
                        <strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Cisco Networking Academy!</strong><br><br>
                        –Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫—É—Ä—Å—É "–í–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–µ—Ç–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏".
                        –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ:<br>
                        ‚Ä¢ –°–µ—Ç–µ–≤—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º (TCP/IP, HTTP, DNS)<br>
                        ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã, –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä—ã)<br>
                        ‚Ä¢ IP-–∞–¥—Ä–µ—Å–∞—Ü–∏–∏ –∏ –ø–æ–¥—Å–µ—Ç—è–º<br>
                        ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–µ–π<br>
                        ‚Ä¢ –ò –¥—Ä—É–≥–∏–º —Ç–µ–º–∞–º –∫—É—Ä—Å–∞!
                    </div>
                    <div class="message-time">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input
                        type="text"
                        id="chatInput"
                        placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –∫—É—Ä—Å—É..."
                        maxlength="500"
                    >
                    <button onclick="sendMessage()" id="sendButton">‚û§</button>
                </div>
                <div class="chat-hint">
                    –ù–∞–ø—Ä–∏–º–µ—Ä: "–û–±—ä—è—Å–Ω–∏ –º–æ–¥–µ–ª—å OSI" –∏–ª–∏ "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è?"
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ -->
<style>
.main-container {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    align-items: start;
}

.content-wrapper {
    min-height: 600px;
}

/* –°—Ç–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.module-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.module-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-decoration: none;
    color: inherit;
    display: block;
    border-left: 6px solid #005073;
    transition: all 0.3s ease;
}

.module-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transform: translateY(-2px);
}

.module-card h3 {
    color: #005073;
    margin: 0 0 0.5rem 0;
}

.module-card p {
    color: #666;
    margin: 0;
    line-height: 1.4;
}

/* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ */
.chat-sidebar {
    position: sticky;
    top: 2rem;
    height: 600px;
}

.chat-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    height: 100%;
    display: flex;
    flex-direction: column;
    border: 1px solid #e1e5e9;
}

.chat-header {
    background: linear-gradient(135deg, #005073, #0078a8);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header h3 {
    margin: 0;
    font-size: 1.1em;
}

.chat-toggle {
    background: none;
    border: none;
    color: white;
    font-size: 1.2em;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.chat-toggle:hover {
    background: rgba(255, 255, 255, 0.2);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-height: 400px;
}

/* –°–∫—Ä—ã–≤–∞–µ–º scrollbar –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.message {
    display: flex;
    flex-direction: column;
    max-width: 85%;
}

.user-message {
    align-self: flex-end;
}

.bot-message {
    align-self: flex-start;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 18px;
    font-size: 0.9em;
    line-height: 1.4;
    word-wrap: break-word;
}

.user-message .message-content {
    background: linear-gradient(135deg, #005073, #0078a8);
    color: white;
    border-bottom-right-radius: 4px;
}

.bot-message .message-content {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.7em;
    color: #666;
    margin-top: 0.25rem;
    padding: 0 0.5rem;
}

.chat-input-container {
    padding: 1rem;
    border-top: 1px solid #e1e5e9;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.chat-input-wrapper {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

#chatInput {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 24px;
    font-size: 0.9em;
    outline: none;
    transition: all 0.3s ease;
    background: white;
}

#chatInput:focus {
    border-color: #005073;
    box-shadow: 0 0 0 2px rgba(0, 80, 115, 0.1);
}

#sendButton {
    background: linear-gradient(135deg, #005073, #0078a8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
}

#sendButton:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 80, 115, 0.3);
}

#sendButton:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.chat-hint {
    font-size: 0.75em;
    color: #666;
    text-align: center;
    font-style: italic;
    line-height: 1.3;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message {
    animation: messageAppear 0.3s ease;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    align-self: flex-start;
    max-width: 85%;
    font-size: 0.9em;
    color: #666;
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
}

.typing-dot {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typingAnimation 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingAnimation {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–¥–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
.message-content code {
    background: rgba(0, 0, 0, 0.05);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}

.bot-message .message-content code {
    background: rgba(0, 80, 115, 0.1);
    color: #005073;
}

.user-message .message-content code {
    background: rgba(255, 255, 255, 0.2);
    color: white;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .main-container {
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .chat-sidebar {
        position: static;
        height: 500px;
        order: -1;
    }

    .content-wrapper {
        min-height: auto;
    }
}

@media (max-width: 768px) {
    .chat-sidebar {
        height: 400px;
    }

    .message {
        max-width: 90%;
    }

    .module-list {
        grid-template-columns: 1fr;
    }

    .chat-header h3 {
        font-size: 1em;
    }
}

@media (max-width: 480px) {
    .chat-container {
        border-radius: 8px;
    }

    .chat-header {
        padding: 0.75rem 1rem;
    }

    .chat-messages {
        padding: 0.75rem;
        gap: 0.75rem;
    }

    .message-content {
        padding: 0.6rem 0.8rem;
        font-size: 0.85em;
    }
}
</style>

<!-- JavaScript –¥–ª—è —á–∞—Ç–∞ -->
<script>
let isChatMinimized = false;
let chatHistory = [];

function toggleChat() {
    const chatContainer = document.querySelector('.chat-container');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.querySelector('.chat-input-container');
    const toggleBtn = document.querySelector('.chat-toggle');

    if (isChatMinimized) {
        // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç
        chatMessages.style.display = 'flex';
        chatInput.style.display = 'block';
        toggleBtn.textContent = '‚àí';
        chatContainer.style.height = '600px';
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    } else {
        // –°–≤–µ—Ä–Ω—É—Ç—å —á–∞—Ç
        chatMessages.style.display = 'none';
        chatInput.style.display = 'none';
        toggleBtn.textContent = '+';
        chatContainer.style.height = 'auto';
    }

    isChatMinimized = !isChatMinimized;
}

function addMessage(message, isUser = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

    const now = new Date();
    const timeString = now.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });

    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    const formattedMessage = formatMessage(message);

    messageDiv.innerHTML = `
        <div class="message-content">${formattedMessage}</div>
        <div class="message-time">${timeString}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
    chatHistory.push({
        role: isUser ? 'user' : 'assistant',
        content: message,
        timestamp: now
    });
}

function formatMessage(text) {
    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –Ω–∞ <br>
    text = text.replace(/\n/g, '<br>');

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–¥ (–ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–ø–∏—Å–∫–∏
    text = text.replace(/^‚Ä¢\s+/gm, '‚Ä¢ ');

    return text;
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div>AI –ø–æ–º–æ—â–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;

    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const button = document.getElementById('sendButton');
    const message = input.value.trim();

    if (!message) return;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    input.value = '';
    button.disabled = true;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, true);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
    showTypingIndicator();

    try {
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô URL –∏ –¥–æ–±–∞–≤–ª–µ–Ω CSRF token
        const response = await fetch('/api/ai-assistant/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()  // –î–æ–±–∞–≤–ª—è–µ–º CSRF token
            },
            body: JSON.stringify({
                message: message
            })
        });

        const data = await response.json();

        hideTypingIndicator();

        if (data.response) {
            addMessage(data.response);
        } else {
            addMessage(`‚ùå ${data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'}`);
        }
    } catch (error) {
        hideTypingIndicator();
        addMessage('üåê –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        console.error('Chat error:', error);
    } finally {
        button.disabled = false;
        input.focus();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF token
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        setTimeout(() => {
            chatInput.focus();
        }, 500);
    }
});

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (chatHistory.length > 0) {
        localStorage.setItem('ciscoChatHistory', JSON.stringify(chatHistory));
    }
});

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    const savedHistory = localStorage.getItem('ciscoChatHistory');
    if (savedHistory) {
        try {
            chatHistory = JSON.parse(savedHistory);
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        } catch (e) {
            console.error('Error loading chat history:', e);
        }
    }
});
</script>
{% endblock %}