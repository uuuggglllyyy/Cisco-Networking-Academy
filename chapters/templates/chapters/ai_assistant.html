{% extends 'chapters/base.html' %}

{% block title %}AI –ü–æ–º–æ—â–Ω–∏–∫ - Cisco Networking Academy{% endblock %}

{% block content %}
<div class="main-container">
    <div class="content-wrapper">
        <div class="chat-header-full">
            <h1>ü§ñ AI –ü–æ–º–æ—â–Ω–∏–∫ Cisco</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Cisco Networking Academy! –Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫—É—Ä—Å—É "–í–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–µ—Ç–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏"</p>

            {% if current_module or current_chapter or current_section %}
            <div class="context-info">
                <strong>–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:</strong>
                {% if current_module %}–ú–æ–¥—É–ª—å: {{ current_module }}{% endif %}
                {% if current_chapter %} ‚Üí –ì–ª–∞–≤–∞: {{ current_chapter }}{% endif %}
                {% if current_section %} ‚Üí –†–∞–∑–¥–µ–ª: {{ current_section }}{% endif %}
            </div>
            {% endif %}

            <a href="{% if module_id %}{% url 'module_detail' module_id %}{% else %}{% url 'module_list' %}{% endif %}" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å—É
            </a>
        </div>

        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —á–∞—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–æ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ -->
        <div class="chat-container-full">
            <div class="chat-messages-full" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-content">
                        <strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Cisco Networking Academy!</strong><br><br>
                        –Ø –≤–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫—É—Ä—Å—É "–í–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–µ—Ç–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏".
                        –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ:<br>
                        ‚Ä¢ –°–µ—Ç–µ–≤—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º (TCP/IP, HTTP, DNS)<br>
                        ‚Ä¢ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä—ã, –∫–æ–º–º—É—Ç–∞—Ç–æ—Ä—ã)<br>
                        ‚Ä¢ IP-–∞–¥—Ä–µ—Å–∞—Ü–∏–∏ –∏ –ø–æ–¥—Å–µ—Ç—è–º<br>
                        ‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ç–µ–π<br>
                        ‚Ä¢ –ò –¥—Ä—É–≥–∏–º —Ç–µ–º–∞–º –∫—É—Ä—Å–∞!
                    </div>
                    <div class="message-time">–¢–æ–ª—å–∫–æ —á—Ç–æ</div>
                </div>
            </div>

            <div class="chat-input-container-full">
                <div class="chat-input-wrapper">
                    <input
                        type="text"
                        id="chatInput"
                        placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –∫—É—Ä—Å—É..."
                        maxlength="500"
                    >
                    <button onclick="sendMessage()" id="sendButton">‚û§</button>
                </div>
                <div class="chat-hint">
                    –ù–∞–ø—Ä–∏–º–µ—Ä: "What is TCP/IP?" –∏–ª–∏ "Explain OSI model" (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∞–Ω–≥–ª–∏–π—Å–∫–∏–π)
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.main-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.chat-header-full {
    text-align: center;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, #005073, #0078a8);
    color: white;
    padding: 2rem;
    border-radius: 12px;
}

.chat-header-full h1 {
    margin: 0 0 1rem 0;
    font-size: 2.5em;
}

.chat-header-full p {
    margin: 0 0 1rem 0;
    opacity: 0.9;
    font-size: 1.1em;
}

.context-info {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.75rem;
    border-radius: 8px;
    margin: 1rem 0;
    font-size: 1em;
}

.chat-container-full {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    height: 70vh;
    display: flex;
    flex-direction: column;
    border: 1px solid #e1e5e9;
}

.chat-messages-full {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-input-container-full {
    padding: 1.5rem;
    border-top: 1px solid #e1e5e9;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

/* –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
.message {
    display: flex;
    flex-direction: column;
    max-width: 70%;
}

.user-message {
    align-self: flex-end;
}

.bot-message {
    align-self: flex-start;
}

.message-content {
    padding: 0.75rem 1rem;
    border-radius: 18px;
    font-size: 0.95em;
    line-height: 1.4;
    word-wrap: break-word;
}

.user-message .message-content {
    background: linear-gradient(135deg, #005073, #0078a8);
    color: white;
    border-bottom-right-radius: 4px;
}

.bot-message .message-content {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #e9ecef;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.7em;
    color: #666;
    margin-top: 0.25rem;
    padding: 0 0.5rem;
}

.chat-input-wrapper {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

#chatInput {
    flex: 1;
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 24px;
    font-size: 0.95em;
    outline: none;
    transition: all 0.3s ease;
    background: white;
}

#chatInput:focus {
    border-color: #005073;
    box-shadow: 0 0 0 2px rgba(0, 80, 115, 0.1);
}

#sendButton {
    background: linear-gradient(135deg, #005073, #0078a8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9em;
}

#sendButton:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0, 80, 115, 0.3);
}

#sendButton:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.chat-hint {
    font-size: 0.8em;
    color: #666;
    text-align: center;
    font-style: italic;
    line-height: 1.3;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    align-self: flex-start;
    max-width: 70%;
    font-size: 0.9em;
    color: #666;
}

.typing-dots {
    display: flex;
    gap: 0.25rem;
}

.typing-dot {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typingAnimation 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typingAnimation {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}
</style>

<script>
let chatHistory = [];

function addMessage(message, isUser = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

    const now = new Date();
    const timeString = now.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });

    const formattedMessage = formatMessage(message);

    messageDiv.innerHTML = `
        <div class="message-content">${formattedMessage}</div>
        <div class="message-time">${timeString}</div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    chatHistory.push({
        role: isUser ? 'user' : 'assistant',
        content: message,
        timestamp: now
    });
}

function formatMessage(text) {
    text = text.replace(/\n/g, '<br>');
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    text = text.replace(/^‚Ä¢\s+/gm, '‚Ä¢ ');
    return text;
}

function showTypingIndicator() {
    const chatMessages = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `
        <div>AI –ø–æ–º–æ—â–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç...</div>
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const button = document.getElementById('sendButton');
    const message = input.value.trim();

    if (!message) return;

    input.value = '';
    button.disabled = true;

    addMessage(message, true);
    showTypingIndicator();

    try {
        const response = await fetch('/api/ai-assistant/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                message: message,
                context: '{% if current_module %}–ú–æ–¥—É–ª—å: {{ current_module }}{% endif %}'
            })
        });

        const data = await response.json();
        hideTypingIndicator();

        if (data.response) {
            addMessage(data.response);
        } else {
            addMessage(`‚ùå ${data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}`);
        }
    } catch (error) {
        hideTypingIndicator();
        addMessage('üåê –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI —Å–µ—Ä–≤–µ—Ä–æ–º');
        console.error('Chat error:', error);
    } finally {
        button.disabled = false;
        input.focus();
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// –ê–≤—Ç–æ-—Ñ–æ–∫—É—Å
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        setTimeout(() => {
            chatInput.focus();
        }, 500);
    }
});
</script>
{% endblock %}